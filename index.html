<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>A B√∫ssola da Alta Performance - Empresarial</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    input, button {
      padding: 10px;
      font-size: 1em;
      margin-top: 10px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .hidden { display: none; }
    label {
      display: block;
      margin: 8px 0;
      cursor: pointer;
    }
    input[type="radio"] {
      margin-right: 8px;
    }
    input[type="text"], input[type="email"] {
      width: 100%;
      max-width: 400px;
      border: 1px solid #333;
      background-color: #222;
      color: #fff;
      border-radius: 4px;
    }
    .progress-bar {
      height: 10px;
      background-color: #333;
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background-color: #007bff;
      width: 0%;
      transition: width 0.3s ease;
    }
    .resultado-container {
      margin-top: 20px;
    }
    .perfil-item { /* Mantido para poss√≠vel uso, mas ser√° mais gen√©rico agora */
      margin: 5px 0;
      font-size: 1.1em;
    }
    .perfil-predominante { /* Este estilo ser√° adaptado ou removido, pois n√£o h√° um √∫nico predominante */
      color: #007bff;
      font-weight: bold;
      font-size: 1.2em;
    }
    #debug-info {
      margin-top: 20px;
      padding: 10px;
      background-color: #333;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      display: none;
    }
    .email-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .success {
      background-color: rgba(40, 167, 69, 0.2);
      border: 1px solid #28a745;
    }
    .error {
      background-color: rgba(220, 53, 69, 0.2);
      border: 1px solid #dc3545;
    }
    .warning {
      background-color: rgba(255, 193, 7, 0.2);
      border: 1px solid #ffc107;
      color: #212529;
    }
    .perfil-detalhado { /* Ser√° adaptado para descri√ß√µes das dimens√µes */
      margin-top: 30px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
    }
    .perfil-detalhado h3 {
      color: #007bff;
      margin-top: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }
    .perfil-secao {
      margin-bottom: 20px;
    }
    .perfil-secao h4 {
      color: #f8f9fa;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .perfil-secao p {
      margin: 5px 0;
      line-height: 1.5;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #007bff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .validation-error {
      color: #dc3545;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>A B√∫ssola da Alta Performance - Empresarial üß†</h2>
  
  <div id="intro-container">
    <label for="name">Digite seu nome completo para come√ßar:</label><br>
    <input type="text" id="name" placeholder="Seu nome aqui" autocomplete="name" required /><br>
    <div id="name-error" class="validation-error hidden">Por favor, insira seu nome completo.</div>
    
    <label for="email">Digite seu e-mail:</label><br>
    <input type="email" id="email" placeholder="Seu e-mail aqui" autocomplete="email" required /><br>
    <div id="email-error" class="validation-error hidden">Por favor, insira um e-mail v√°lido.</div>
    
    <button id="start-button">Come√ßar</button>
  </div>

  <div id="quiz" class="hidden">
    <div class="progress-bar">
      <div id="progress" class="progress"></div>
    </div>
    <div id="question-container"></div>
  </div>

  <div id="resultado-container" class="hidden resultado-container">
    <h3 id="perfil-titulo"></h3>
    <div id="perfil-detalhes"></div>
    <div id="grafico-container">
      <canvas id="graficoPerfil" width="300" height="300"></canvas>
    </div>
    
    <div id="perfil-detalhado" class="perfil-detalhado"></div>
    
    <div id="email-status" class="email-status hidden"></div>
    
    <div class="container" style="margin-top: 20px;">
      <button id="restart-button">Refazer Teste</button>
    </div>
    <div id="debug-info"></div>
  </div>
  
  <script>
    // Configura√ß√µes e constantes
    const CONFIG = {
      WEBHOOK_URL: "https://primary-kh0f-zuper.up.railway.app/webhook/bussola_empresarial",
      MAX_RETRIES: 3,
      RETRY_DELAY: 2000,
      EMAIL_SEND_DELAY: 1000
    };

    // Array completo com as 16 categorias/perguntas e suas op√ß√µes (sem embaralhamento)
    const categoriasBase = [
      {
        categoria: "LIDERAN√áA",
        opcoes: [
          { texto: "Funcional", valor: 4 },
          { texto: "Organizacional", valor: 3 },
          { texto: "L√≠deres", valor: 2 },
          { texto: "Comandar", valor: 1 }
        ]
      },
      {
        categoria: "ESTRUTURA",
        opcoes: [
          { texto: "Organograma", valor: 4 },
          { texto: "Personograma", valor: 3 },
          { texto: "Tribograma", valor: 2 },
          { texto: "Eugrama", valor: 1 }
        ]
      },
      {
        categoria: "PESSOAS",
        opcoes: [
          { texto: "Times", valor: 4 },
          { texto: "Colaboradores", valor: 3 },
          { texto: "Ajudantes", valor: 2 },
          { texto: "Volunt√°rios", valor: 1 }
        ]
      },
      {
        categoria: "PROCESSOS",
        opcoes: [
          { texto: "Fluxos & Governan√ßa", valor: 4 },
          { texto: "Fluxos B√°sicos", valor: 3 },
          { texto: "Caminho", valor: 2 },
          { texto: "Decis√µes", valor: 1 }
        ]
      },
      {
        categoria: "CULTURA",
        opcoes: [
          { texto: "Prop√≥sito", valor: 4 },
          { texto: "Valores", valor: 3 },
          { texto: "Comportamento", valor: 2 },
          { texto: "Ambiente", valor: 1 }
        ]
      },
      {
        categoria: "AMBIENTE",
        opcoes: [
          { texto: "Dominante", valor: 4 },
          { texto: "Competitivo", valor: 3 },
          { texto: "Flex√≠vel", valor: 2 },
          { texto: "Estimulante", valor: 1 }
        ]
      },
      {
        categoria: "FOCO",
        opcoes: [
          { texto: "Time", valor: 4 },
          { texto: "Empresa", valor: 3 },
          { texto: "Produto", valor: 2 },
          { texto: "Cliente", valor: 1 }
        ]
      },
      {
        categoria: "ESTRAT√âGIA",
        opcoes: [
          { texto: "Implementar", valor: 4 },
          { texto: "Realizar", valor: 3 },
          { texto: "Planejar", valor: 2 },
          { texto: "Executar", valor: 1 }
        ]
      },
      {
        categoria: "EXPERI√äNCIA",
        opcoes: [
          { texto: "Excel√™ncia", valor: 4 },
          { texto: "Satisfa√ß√£o", valor: 3 },
          { texto: "Engajamento", valor: 2 },
          { texto: "Inova√ß√£o", valor: 1 }
        ]
      },
      {
        categoria: "SA√öDE",
        opcoes: [
          { texto: "Financeiro", valor: 4 },
          { texto: "F√≠sico", valor: 3 },
          { texto: "Mental", valor: 2 },
          { texto: "Emocional", valor: 1 }
        ]
      },
      {
        categoria: "FERRAMENTAS",
        opcoes: [
          { texto: "Especializadas", valor: 4 },
          { texto: "B√°sicas", valor: 3 },
          { texto: "Digitais", valor: 2 },
          { texto: "Manuais", valor: 1 }
        ]
      },
      {
        categoria: "DADOS",
        opcoes: [
          { texto: "Positivos", valor: 4 },
          { texto: "Negativos", valor: 3 },
          { texto: "Qualitativos", valor: 2 },
          { texto: "Quantitativos", valor: 1 }
        ]
      },
      {
        categoria: "RESULTADO",
        opcoes: [
          { texto: "Objetivos", valor: 4 },
          { texto: "Metas", valor: 3 },
          { texto: "Lucro", valor: 2 },
          { texto: "Impacto", valor: 1 }
        ]
      },
      {
        categoria: "OBJETIVO",
        opcoes: [
          { texto: "Profissionalizar", valor: 4 },
          { texto: "Otimizar", valor: 3 },
          { texto: "Diversificar", valor: 2 },
          { texto: "Expandir", valor: 1 }
        ]
      },
      {
        categoria: "PAPEL DO DONO",
        opcoes: [
          { texto: "Empreender Tudo", valor: 4 },
          { texto: "Gerenciar Tudo", valor: 3 },
          { texto: "Fazer Tudo", valor: 2 },
          { texto: "Decidir Tudo", valor: 1 }
        ]
      },
      {
        categoria: "VERBO",
        opcoes: [
          { texto: "Dirigir", valor: 4 },
          { texto: "Coordenar", valor: 3 },
          { texto: "Fazer", valor: 2 },
          { texto: "Conduzir", valor: 1 }
        ]
      }
    ];
    
    // Vari√°veis globais
    let perguntas = []; // Agora s√£o as categorias
    let respostas = {}; // Armazena a op√ß√£o escolhida por categoria
    let pontuacoesCategorias = {}; // Armazena a pontua√ß√£o total por categoria
    let userName = "";
    let userEmail = "";
    let perguntaAtual = 0;
    let debugMode = false;
    let resultadoAtual = null; // Armazenar√° os resultados processados
    let graficoChart = null;
    let emailEnviado = false;
    let tentativasEnvio = 0;

    // Informa√ß√µes detalhadas sobre cada categoria (opcional, para futura expans√£o)
    // No momento, n√£o h√° descri√ß√µes detalhadas fornecidas para cada uma das 16 categorias.
    // Esta se√ß√£o pode ser expandida no futuro se houver necessidade de explicar o que significa cada pontua√ß√£o.
    const categoriasDetalhe = {
      'LIDERAN√áA': {
        descricao: 'Avalia o estilo e a efic√°cia da lideran√ßa na organiza√ß√£o.'
      },
      'ESTRUTURA': {
        descricao: 'Mede a clareza e adequa√ß√£o da estrutura organizacional.'
      },
      'PESSOAS': {
        descricao: 'Foca na gest√£o de talentos e no ambiente humano da empresa.'
      },
      'PROCESSOS': {
        descricao: 'Avalia a efici√™ncia e a padroniza√ß√£o dos processos internos.'
      },
      'CULTURA': {
        descricao: 'Reflete os valores, cren√ßas e comportamentos predominantes.'
      },
      'AMBIENTE': {
        descricao: 'Analisa o clima e as condi√ß√µes de trabalho.'
      },
      'FOCO': {
        descricao: 'Determina para onde a aten√ß√£o e os recursos da empresa est√£o direcionados.'
      },
      'ESTRAT√âGIA': {
        descricao: 'Avalia a clareza e a execu√ß√£o dos planos de longo prazo.'
      },
      'EXPERI√äNCIA': {
        descricao: 'Mede a qualidade das intera√ß√µes e a satisfa√ß√£o geral.'
      },
      'SA√öDE': {
        descricao: 'Examina o bem-estar financeiro, f√≠sico e mental da organiza√ß√£o e seus membros.'
      },
      'FERRAMENTAS': {
        descricao: 'Avalia a disponibilidade e o uso de recursos e tecnologias.'
      },
      'DADOS': {
        descricao: 'Foca na coleta, an√°lise e utiliza√ß√£o de informa√ß√µes para decis√µes.'
      },
      'RESULTADO': {
        descricao: 'Mede o desempenho e a consecu√ß√£o de metas e objetivos.'
      },
      'OBJETIVO': {
        descricao: 'Determina a clareza e a ambi√ß√£o dos prop√≥sitos da empresa.'
      },
      'PAPEL DO DONO': {
        descricao: 'Avalia a atua√ß√£o e o envolvimento do propriet√°rio ou principal gestor.'
      },
      'VERBO': {
        descricao: 'Representa a a√ß√£o e a din√¢mica principal da empresa.'
      }
    };

    // Utilit√°rios
    const Utils = {
      // Valida√ß√£o de e-mail
      validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
      },

      // Valida√ß√£o de nome
      validarNome(nome) {
        return nome && nome.trim().length >= 2;
      },

      // Fun√ß√£o para debug
      debug(mensagem, dados = null) {
        if (debugMode) {
          const debugInfo = document.getElementById("debug-info");
          debugInfo.style.display = "block";
          debugInfo.textContent += `\n[${new Date().toLocaleTimeString()}] ${mensagem}`;
          if (dados) {
            debugInfo.textContent += `\nDados: ${JSON.stringify(dados, null, 2)}`;
          }
        }
        console.log(`[DEBUG] ${mensagem}`, dados);
      },

      // Fun√ß√£o para delay
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    };

    // Valida√ß√£o de formul√°rio
    const Validation = {
      showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
      },

      hideError(elementId) {
        const errorElement = document.getElementById(elementId);
        errorElement.classList.add('hidden');
      },

      validateForm() {
        let isValid = true;
        
        // Validar nome
        const nome = document.getElementById("name").value.trim();
        if (!Utils.validarNome(nome)) {
          this.showError('name-error', 'Por favor, insira seu nome completo (m√≠nimo 2 caracteres).');
          isValid = false;
        } else {
          this.hideError('name-error');
        }

        // Validar e-mail
        const email = document.getElementById("email").value.trim();
        if (!Utils.validarEmail(email)) {
          this.showError('email-error', 'Por favor, insira um e-mail v√°lido.');
          isValid = false;
        } else {
          this.hideError('email-error');
        }

        return isValid;
      }
    };

    // Gerenciador de estado da aplica√ß√£o
    const AppState = {
      reset() {
        respostas = {};
        pontuacoesCategorias = {}; // Resetar pontua√ß√µes
        perguntaAtual = 0;
        resultadoAtual = null;
        emailEnviado = false;
        tentativasEnvio = 0;
        
        if (graficoChart) {
          graficoChart.destroy();
          graficoChart = null;
        }
      },

      initializeCategories() {
        // As categorias j√° est√£o na ordem desejada em categoriasBase
        perguntas = categoriasBase; // 'perguntas' agora representa as categorias
        // Inicializa as pontua√ß√µes para cada categoria
        categoriasBase.forEach(cat => {
            pontuacoesCategorias[cat.categoria] = 0;
        });
      }
    };

    // Gerenciador de UI
    const UI = {
      showSection(sectionId) {
        document.querySelectorAll('.hidden').forEach(el => {
          if (el.id !== sectionId) el.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');
      },

      updateProgressBar() {
        const progresso = (perguntaAtual / perguntas.length) * 100;
        document.getElementById("progress").style.width = `${progresso}%`;
      },

      showLoadingMessage(message) {
        document.getElementById("question-container").innerHTML = `<div class="loading">${message}</div>`;
      },

      showStatusMessage(elementId, message, type = null) {
        const element = document.getElementById(elementId);
        element.classList.remove("hidden", "success", "error", "warning");
        
        if (type) {
          element.classList.add(type);
        }
        
        element.textContent = message;
      }
    };

    // Gerenciador de resultados
    const ResultsManager = {
        calculateAndDisplayResults() {
            document.getElementById("quiz").classList.add("hidden");
            document.getElementById("resultado-container").classList.remove("hidden");

            // N√£o precisamos mais de percentuais calculados aqui se o gr√°fico for de 1-4
            // O webhook ainda pode precisar dos percentuais, ent√£o vamos mant√™-los para o `resultadoAtual`
            const maxScorePerCategory = 4;
            const percentuaisCalculados = {};
            for (const categoria in pontuacoesCategorias) {
                const score = pontuacoesCategorias[categoria];
                percentuaisCalculados[categoria] = (score / maxScorePerCategory) * 100;
            }

            Utils.debug("Pontua√ß√µes por Categoria:", pontuacoesCategorias);
            Utils.debug("Percentuais Calculados (apenas para webhook/n8n):", percentuaisCalculados);

            // Preparar dados para exibi√ß√£o e webhook
            resultadoAtual = {
                userName: userName,
                userEmail: userEmail,
                pontuacoesCategorias: pontuacoesCategorias, // As pontua√ß√µes de 1-4
                percentuaisCategorias: percentuaisCalculados // Os percentuais de 0-100% para o n8n
            };

            this.renderResults(resultadoAtual);
            // Passa as pontua√ß√µes diretas para o gr√°fico
            this.createChart(resultadoAtual.pontuacoesCategorias); 

            // Configurar bot√£o de reiniciar
            document.getElementById("restart-button").addEventListener("click", () => {
                location.reload();
            });

            // Enviar e-mail ap√≥s renderizar
            setTimeout(() => {
                EmailManager.sendResultEmail();
            }, CONFIG.EMAIL_SEND_DELAY);
        },

        showError(message) {
            document.getElementById("perfil-titulo").textContent = "Erro ao processar resultados";
            document.getElementById("perfil-detalhes").innerHTML = `<p>${message}</p>`;
        },

        renderResults(data) {
            document.getElementById("perfil-titulo").innerHTML = `${data.userName}, aqui est√° a B√∫ssola da Alta Performance da sua empresa!`;

            let detalhesHTML = "<p>Esta b√∫ssola reflete suas escolhas em diversas dimens√µes empresariais:</p>";
            detalhesHTML += "<ul>";
            // Exibir as pontua√ß√µes diretas (1-4) aqui
            for (const categoria in data.pontuacoesCategorias) {
                detalhesHTML += `<li class="perfil-item"><strong>${categoria}</strong>: ${data.pontuacoesCategorias[categoria]}</li>`;
            }
            detalhesHTML += "</ul>";
            detalhesHTML += "<p>Obrigado por participar da avalia√ß√£o!</p>";
            document.getElementById("perfil-detalhes").innerHTML = detalhesHTML;
            document.getElementById("perfil-detalhado").innerHTML = ""; // Limpar se√ß√£o detalhada, pois n√£o h√° perfis espec√≠ficos
        },

        createChart(pontuacoes) { // Agora recebe as pontua√ß√µes diretas (1-4)
            if (typeof Chart === 'undefined') {
                Utils.debug("Chart.js n√£o dispon√≠vel");
                return;
            }

            Utils.debug("Criando gr√°fico com pontua√ß√µes diretas", pontuacoes);

            const labels = categoriasBase.map(cat => cat.categoria);
            const values = labels.map(label => pontuacoes[label] || 0); // Usa as pontua√ß√µes diretas

            const ctx = document.getElementById("graficoPerfil").getContext("2d");

            // Cores gen√©ricas para as 16 categorias (pode ser ajustado se houver prefer√™ncia de cores)
            const backgroundColors = [
                'rgba(0, 123, 255, 0.3)', // Cor principal azul
                'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(199, 199, 199, 0.2)', 'rgba(83, 102, 255, 0.2)',
                'rgba(99, 255, 132, 0.2)', 'rgba(162, 54, 235, 0.2)', 'rgba(206, 255, 86, 0.2)', 'rgba(192, 75, 192, 0.2)',
                'rgba(102, 153, 255, 0.2)', 'rgba(159, 255, 64, 0.2)', 'rgba(199, 83, 102, 0.2)', 'rgba(255, 99, 132, 0.2)'
            ];
            const borderColors = [
                'rgb(0, 123, 255)', // Cor principal azul
                'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)', 'rgb(75, 192, 192)',
                'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgb(199, 199, 199)', 'rgb(83, 102, 255)',
                'rgb(99, 255, 132)', 'rgb(162, 54, 235)', 'rgb(206, 255, 86)', 'rgb(192, 75, 192)',
                'rgb(102, 153, 255)', 'rgb(159, 255, 64)', 'rgb(199, 83, 102)', 'rgb(255, 99, 132)'
            ];


            if (graficoChart) {
                graficoChart.destroy(); // Destruir o gr√°fico anterior se existir
            }

            graficoChart = new Chart(ctx, {
                type: "radar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sua Pontua√ß√£o', // R√≥tulo sem '%'
                        data: values,
                        backgroundColor: 'rgba(0, 123, 255, 0.3)', /* Cor de preenchimento azul */
                        borderColor: 'rgb(0, 123, 255)', /* Cor da linha azul */
                        pointBackgroundColor: backgroundColors, /* Cores para os pontos */
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: borderColors,
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.3)',
                                lineWidth: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.3)',
                                lineWidth: 1
                            },
                            pointLabels: {
                                color: '#fff',
                                font: {
                                    size: 10, // Ajustado para caber 16 labels
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#fff',
                                backdropColor: 'rgba(0, 0, 0, 0.7)',
                                beginAtZero: true,
                                min: 0, // **Inicia explicitamente em 0**
                                max: 4, 
                                stepSize: 1, 
                                showLabelBackdrop: true,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: "Distribui√ß√£o da B√∫ssola da Alta Performance",
                            color: "#ffffff",
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    // Mostra o r√≥tulo e o valor da pontua√ß√£o (0-4)
                                    return `${context.label}: ${context.parsed.r}`;
                                }
                            }
                        }
                    }
                }
            });

            Utils.debug("Gr√°fico de teia criado com sucesso.");
        }
    };

    // Gerenciador de e-mail
    const EmailManager = {
        async sendResultEmail() {
            if (emailEnviado || !this.isValidResult()) {
                Utils.debug("E-mail n√£o enviado - j√° enviado ou resultado inv√°lido");
                return;
            }
            emailEnviado = true;
            UI.showStatusMessage("email-status", "Enviando resultado para seu e-mail...", null);

            try {
                const emailData = this.prepareEmailData();
                
                const response = await fetch(CONFIG.WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(emailData)
                });

                if (response.ok) {
                    UI.showStatusMessage("email-status", 
                      `Resultado enviado com sucesso para ${resultadoAtual.userEmail}!`, "success");
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                Utils.debug("Erro ao enviar e-mail", error);
                UI.showStatusMessage("email-status", 
                  "Erro ao enviar e-mail. Por favor, tente novamente mais tarde.", "error");
                emailEnviado = false;
            }
        },

        isValidResult() {
            // Verifica se h√° pontua√ß√µes calculadas e se o e-mail est√° presente
            return resultadoAtual &&
                    Object.keys(resultadoAtual.pontuacoesCategorias).length > 0 && // Mudado para pontuacoesCategorias
                    resultadoAtual.userEmail;
        },

        prepareEmailData() {
            let graficoImgBase64 = null;
            
            try {
                if (graficoChart) {
                    const canvas = document.getElementById("graficoPerfil");
                    graficoImgBase64 = canvas.toDataURL("image/png");
                }
            } catch (error) {
                Utils.debug("Erro ao capturar gr√°fico para e-mail", error);
            }

            return {
                userName: resultadoAtual.userName,
                userEmail: resultadoAtual.userEmail,
                // Mantemos percentuaisCategorias aqui, pois o n8n JSON Code pode ainda esperar isso para a an√°lise detalhada.
                pontuacoesCategorias: resultadoAtual.pontuacoesCategorias, 
                percentuaisCategorias: resultadoAtual.percentuaisCategorias,
                graficoBase64: graficoImgBase64,
                acao: "enviar_email_bussola" // A√ß√£o espec√≠fica para o webhook
            };
        }
    };

    // Gerenciador de quiz
    const QuizManager = {
      start() {
        if (!Validation.validateForm()) {
          return;
        }

        userName = document.getElementById("name").value.trim();
        userEmail = document.getElementById("email").value.trim();

        AppState.reset();
        AppState.initializeCategories(); // Inicializa as categorias e pontua√ß√µes

        document.getElementById("intro-container").classList.add("hidden");
        document.getElementById("quiz").classList.remove("hidden");

        UI.updateProgressBar();
        this.showQuestion(perguntaAtual);
      },

      showQuestion(index) {
        if (index >= perguntas.length) {
          ResultsManager.calculateAndDisplayResults(); // Agora calcula e exibe localmente
          return;
        }

        const categoria = perguntas[index];
        // O texto da "pergunta" √© o nome da categoria
        let html = `<p><strong>${index + 1}/${perguntas.length}. Selecione a op√ß√£o que melhor descreve a dimens√£o "${categoria.categoria}":</strong></p>`;
        
        categoria.opcoes.forEach((opcao, idx) => {
          // Usamos o index para manter a ordem e garantir a pontua√ß√£o (4,3,2,1)
          html += `<label><input type="radio" name="resposta" value="${opcao.valor}" data-categoria="${categoria.categoria}" /> ${String.fromCharCode(97 + idx)}) ${opcao.texto}</label>`;
        });
        
        html += `<div class="container" style="margin-top: 15px;"><button id="next-button">Pr√≥xima</button></div>`;
        
        document.getElementById("question-container").innerHTML = html;
        
        document.getElementById("next-button").addEventListener("click", () => {
          this.registerAnswer(index);
        });
      },

      registerAnswer(index) {
        const selected = document.querySelector("input[name='resposta']:checked");
        if (!selected) {
          alert("Por favor, selecione uma resposta.");
          return;
        }

        const categoriaSelecionada = perguntas[index].categoria;
        const valorSelecionado = parseInt(selected.value);

        // Armazena a pontua√ß√£o para a categoria atual
        pontuacoesCategorias[categoriaSelecionada] = valorSelecionado;
        Utils.debug(`Resposta para ${categoriaSelecionada}: ${valorSelecionado} pontos`);

        perguntaAtual++;
        UI.updateProgressBar();
        this.showQuestion(perguntaAtual);
      }
    };

    // Inicializa√ß√£o da aplica√ß√£o
    document.addEventListener("DOMContentLoaded", function() {
      // Configurar eventos
      document.getElementById("start-button").addEventListener("click", () => {
        QuizManager.start();
      });
      
      // Verificar modo debug
      if (window.location.search.includes('debug=true')) {
        debugMode = true;
        document.getElementById("debug-info").style.display = "block";
        Utils.debug("Modo de debug ativado");
      }

      // Valida√ß√£o em tempo real
      document.getElementById("name").addEventListener("blur", () => {
        const nome = document.getElementById("name").value.trim();
        if (nome && !Utils.validarNome(nome)) {
          Validation.showError('name-error', 'Nome deve ter pelo menos 2 caracteres.');
        } else {
          Validation.hideError('name-error');
        }
      });

      document.getElementById("email").addEventListener("blur", () => {
        const email = document.getElementById("email").value.trim();
        if (email && !Utils.validarEmail(email)) {
          Validation.showError('email-error', 'Por favor, insira um e-mail v√°lido.');
        } else {
          Validation.hideError('email-error');
        }
      });
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
